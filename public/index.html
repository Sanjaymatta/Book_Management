<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Management System</title>
</head>
<body>
    <h1>Welcome to the Book Management System</h1>

    <h2>Add a New Book</h2>
    <form id="add-book-form">
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required><br>

        <label for="author">Author:</label>
        <input type="text" id="author" name="author" required><br>

        <label for="genre">Genre:</label>
        <input type="text" id="genre" name="genre"><br>

        <button type="submit">Add Book</button>
    </form>

    <h2>List of Books</h2>
    <ul id="book-list"></ul>

    <h2>Add a New Student</h2>
    <form id="add-student-form">
        <label for="student">Name:</label>
        <input type="text" id="student" name="student" required><br>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required><br>

        <label for="regNo">Registration Number:</label>
        <input type="number" id="regNo" name="regNo" required><br> <!-- New field for registration number -->

        <button type="submit">Add Student</button>
    </form>

    <h2>List of Students</h2>
    <ul id="student-list"></ul>

    <h2>Return a Book</h2>
    <form id="return-book-form">
        <label for="student-select">Select Student:</label>
        <select id="student-select" name="student-select"></select><br>

        <label for="book-select">Select Book:</label>
        <select id="book-select" name="book-select"></select><br>

        <button type="submit">Return Book</button>
    </form>

    <script>
        async function fetchBooks() {
            const response = await fetch('/api/books');
            const books = await response.json();

            const bookList = document.getElementById('book-list');
            bookList.innerHTML = '';

            books.forEach(book => {
                const li = document.createElement('li');
                li.textContent = `Title: ${book.title}, Author: ${book.author}, Genre: ${book.genre}, Available: ${book.available ? 'Yes' : 'No'}`;

                const assignButton = document.createElement('button');
                assignButton.textContent = 'Assign';
                assignButton.addEventListener('click', () => assignBookToStudent(book._id));

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deleteBook(book._id));

                li.appendChild(assignButton);
                li.appendChild(deleteButton);
                bookList.appendChild(li);
            });
        }

        async function fetchStudents() {
    try {
        const response = await fetch('/api/books/students/borrow');
        const students = await response.json();

        const studentList = document.getElementById('student-list');
        studentList.innerHTML = '';

        students.forEach(student => {
            const li = document.createElement('li');
            li.textContent = `Name: ${student.name}, Email: ${student.email}, Reg No: ${student.regNo}`;

            studentList.appendChild(li);

            // Populate the student select dropdown for returning books
            const studentOption = document.createElement('option');
            studentOption.textContent = student.name;
            studentOption.value = student.regNo;
            document.getElementById('student-select').appendChild(studentOption);

            // If the current student has borrowed books, fetch and populate the book dropdown
            if (student.borrowedBooks.length > 0) {
                const bookDropdown = document.getElementById('book-select');
                student.borrowedBooks.forEach(book => {
                    const bookOption = document.createElement('option');
                    bookOption.textContent = `${book.title} by ${book.author}`;
                    bookOption.value = book._id;
                    bookDropdown.appendChild(bookOption);
                });
            }
        });
    } catch (error) {
        console.error('Error:', error.message);
        // Handle error: Display an error message to the user
    }
}



        async function addBook(title, author, genre) {
            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, author, genre })
                });
                if (response.ok) {
                    fetchBooks();
                } else {
                    throw new Error('Failed to add book');
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        }

        async function deleteBook(id) {
            try {
                const response = await fetch(`/api/books/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    fetchBooks();
                } else {
                    throw new Error('Failed to delete book');
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        }

        async function assignBookToStudent(bookId) {
            const regNo = prompt('Enter student registration number:'); // Prompt the user to enter the student's registration number
            if (!regNo) return;

            try {
                const response = await fetch(`/api/books/${bookId}/borrow`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ regNo }) // Send the entered registration number in the request body
                });
                if (response.ok) {
                    fetchBooks();
                } else {
                    throw new Error('Failed to assign book to student');
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        }

        async function addStudent(name, email, regNo) {
            try {
                const response = await fetch('/api/books/students', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, regNo })
                });
                if (response.ok) {
                    fetchStudents();
                } else {
                    throw new Error('Failed to add student');
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        }

        async function returnBook(regNo, bookId) {
            try {
                const response = await fetch(`/api/books/${bookId}/return`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ regNo }) // Send the student's registration number in the request body
                });
                if (response.ok) {
                    fetchBooks();
                } else {
                    throw new Error('Failed to return book');
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        }

        document.getElementById('add-book-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const title = form['title'].value;
            const author = form['author'].value;
            const genre = form['genre'].value;
            addBook(title, author, genre);
            form.reset();
        });

        document.getElementById('add-student-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const name = form['student'].value;
            const email = form['email'].value;
            const regNo = form['regNo'].value;
            addStudent(name, email, regNo);
            form.reset();
        });

        document.getElementById('return-book-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const regNo = form['student-select'].value;
            console.log(regNo);
            const bookId = form['book-select'].value;
            returnBook(regNo, bookId);
            form.reset();
        });

        fetchBooks(); // Initial fetch to load books
        fetchStudents(); // Initial fetch to load students
    </script>
</body>
</html>
